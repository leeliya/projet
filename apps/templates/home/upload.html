{% extends 'layouts/base-fullscreen.html' %}
{% block title %}Analyse de trafic réseau - SafeNet IDS{% endblock title %}

{% block stylesheets %}
<!-- Mode sombre - Styles complets pour upload.html -->
<style>
  /* Mode sombre - Body et background */
  body.dark-version {
    background: #1a1f2e !important;
    color: #ffffff !important;
  }

  body.dark-version .main-content {
    background: #1a1f2e !important;
  }

  /* Mode sombre - Cards - Surcharge des styles inline */
  body.dark-version .card {
    background-color: #404B69 !important;
    color: #f8f9fa !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
  }

  body.dark-version .card[style*="background-color: var(--bs-body-bg)"] {
    background-color: #404B69 !important;
  }

  body.dark-version .card[style*="color: var(--bs-body-color)"] {
    color: #f8f9fa !important;
  }

  body.dark-version .card-header {
    background: linear-gradient(135deg, #6a007d, #cb0c9f) !important;
    border-bottom: 1px solid rgba(255,255,255,0.1) !important;
  }

  /* Mode sombre - Form controls - Surcharge des styles inline */
  body.dark-version .form-control {
    background-color: #283149 !important;
    color: #f1f1f1 !important;
    border-color: rgba(255,255,255,0.2) !important;
  }

  body.dark-version .form-control[style*="background-color: var(--bs-body-bg)"] {
    background-color: #283149 !important;
  }

  body.dark-version .form-control[style*="color: var(--bs-body-color)"] {
    color: #f1f1f1 !important;
  }

  body.dark-version .form-control:focus {
    background-color: #283149 !important;
    color: #f1f1f1 !important;
    border-color: #6a007d !important;
    box-shadow: 0 0 0 0.2rem rgba(106, 0, 125, 0.25) !important;
  }

  body.dark-version select.form-control {
    background-color: #283149 !important;
    background-image: url("data:image/svg+xml;utf8,<svg fill='white' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='20' height='20'><path d='M7 10l5 5 5-5z'/></svg>") !important;
    color: #f1f1f1 !important;
  }

  body.dark-version select.form-control option {
    background-color: #283149 !important;
    color: #f1f1f1 !important;
  }

  /* Mode sombre - Text */
  body.dark-version small.text-muted {
    color: rgba(255,255,255,0.6) !important;
  }

  body.dark-version .text-muted {
    color: rgba(255,255,255,0.7) !important;
  }

  body.dark-version ol.text-muted li,
  body.dark-version ul.text-muted li {
    color: rgba(255,255,255,0.7) !important;
  }

  /* Mode sombre - Headings et labels */
  body.dark-version h4,
  body.dark-version h5,
  body.dark-version label,
  body.dark-version .fw-bold {
    color: #ffffff !important;
  }

  body.dark-version h5[style*="color: #6a007d"] {
    color: #cb0c9f !important;
  }

  body.dark-version p {
    color: rgba(255,255,255,0.9) !important;
  }

  body.dark-version p[style*="color: var(--bs-body-color)"] {
    color: rgba(255,255,255,0.9) !important;
  }

  /* Mode sombre - Container */
  body.dark-version .container-fluid {
    background: transparent !important;
  }

  /* Mode sombre - Navigation */
  body.dark-version .navbar,
  body.dark-version .navbar-main {
    background: rgba(26, 31, 46, 0.95) !important;
    backdrop-filter: blur(10px) !important;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3) !important;
  }

  body.dark-version .navbar[style*="background: rgba(255,255,255,0.95)"] {
    background: rgba(26, 31, 46, 0.95) !important;
  }

  /* Mode sombre - Breadcrumb */
  body.dark-version .breadcrumb {
    background: transparent !important;
  }

  body.dark-version .breadcrumb-item a {
    color: #cb0c9f !important;
  }

  body.dark-version .breadcrumb-item a[style*="color: #6a007d"] {
    color: #cb0c9f !important;
  }

  body.dark-version .breadcrumb-item.active,
  body.dark-version .breadcrumb-item {
    color: rgba(255,255,255,0.8) !important;
  }

  body.dark-version .breadcrumb-item.active[style*="color: #344767"],
  body.dark-version .breadcrumb-item[style*="color: #344767"] {
    color: rgba(255,255,255,0.8) !important;
  }

  /* Mode sombre - Navbar buttons et icons */
  body.dark-version .nav-link,
  body.dark-version .btn.text-body {
    color: rgba(255,255,255,0.8) !important;
  }

  body.dark-version #theme-toggle,
  body.dark-version #theme-toggle svg {
    color: rgba(255,255,255,0.8) !important;
  }

  body.dark-version #theme-toggle:hover {
    color: #ffffff !important;
  }

  body.dark-version .sidenav-toggler-inner,
  body.dark-version .sidenav-toggler-line {
    background-color: rgba(255,255,255,0.8) !important;
  }

  body.dark-version .sidenav-toggler-inner:hover .sidenav-toggler-line {
    background-color: #ffffff !important;
  }

  /* Mode sombre - Navbar text */
  body.dark-version .navbar-nav .nav-link {
    color: rgba(255,255,255,0.8) !important;
  }

  body.dark-version .navbar-nav .nav-link:hover {
    color: #ffffff !important;
  }
</style>
{% endblock stylesheets %}

{% block content %}
{% include 'includes/sidebar.html' %}

<main class="main-content position-relative border-radius-lg">
  {% include 'includes/navigation.html' %}

  <div class="container-fluid py-4">
    <div class="row">
      <div class="col-lg-12">
        <div class="card shadow border-0"
             style="background-color: var(--bs-body-bg); color: var(--bs-body-color);">
          
          <!-- EN-TÊTE -->
          <div class="card-header text-center"
               style="background: linear-gradient(135deg, #6a007d, #cb0c9f);">
            <h4 class="mb-0 fw-bold" style="color: rgba(255,255,255,0.95);">
              Analyse de fichiers réseau – Lancement d’une détection
            </h4>
          </div>

          <!-- CORPS -->
          <div class="card-body px-5 py-4">
            <p class="mb-4" style="color: var(--bs-body-color);">
              Importez un fichier de trafic réseau pour lancer une analyse. 
              Le système analysera automatiquement les flux et détectera les comportements anormaux 
              à l’aide du modèle de prédiction sélectionné.
            </p>

            <!-- FORMULAIRE -->
            <form id="uploadForm" method="POST" enctype="multipart/form-data"
                  action="{{ url_for('home_blueprint.upload_file') }}">
              
              <!-- Modèle de prédiction -->
              <div class="mb-3">
                <label for="model" class="label-theme fw-bold" style="color: #6a007d;">Modèle de prédiction :</label>
                <div class="input-group">
                  <select name="model" id="model" class="form-control"
                          style="appearance: none;
                                 background-color: var(--bs-body-bg);
                                 color: var(--bs-body-color);
                                 border: 1px solid rgba(0,0,0,0.1);
                                 background-image: url('data:image/svg+xml;utf8,<svg fill=\'%236a007d\' xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' width=\'20\' height=\'20\'><path d=\'M7 10l5 5 5-5z\'/></svg>');
                                 background-repeat: no-repeat;
                                 background-position: right 1rem center;
                                 background-size: 1em;
                                 padding-right: 2.5rem;">
                    <option value="ensemble">Ensemble – Best Hybrid Model</option>
                    <option value="xgb">XGBoost – Gradient Boosting</option>
                    <option value="rf">Random Forest – Forest Classifier</option>
                    <option value="dnn">DNN – Deep Neural Network</option>
                    <option value="cnn">CNN – Convolutional Neural Network</option>
                  </select>
                </div>
              </div>

              <!-- Fichier à analyser -->
              <div class="mb-3">
                <label for="file" class="label-theme fw-bold" style="color: #6a007d;">Fichier à analyser :</label>
                <input type="file" name="file" id="file" class="form-control"
                       accept=".pcap,.pcapng,.cap" required>
                <small class="text-muted">Formats acceptés : .pcap, .pcapng, .cap</small>
              </div>

              <!-- Bouton -->
              <div class="text-center mt-4">
                <button type="submit" class="btn text-white px-5 fw-bold"
                        style="background: linear-gradient(135deg, #6a007d, #cb0c9f); border: none;">
                  Lancer l’analyse
                </button>
                <button type="button" id="resetBtn" class="btn btn-outline-secondary px-4 fw-bold ms-2">
                  Réinitialiser
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTIONS D’INFORMATION -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100"
             style="background-color: var(--bs-body-bg); color: var(--bs-body-color);">
          <div class="card-body">
            <h5 class="fw-bold mb-3" style="color: #6a007d;">Comment utiliser cette section</h5>
            <ol class="text-muted">
              <li>Capturez le trafic réseau (fichier PCAP/PCAPNG)</li>
              <li>Importez le fichier dans SafeNet IDS</li>
              <li>Sélectionnez le modèle d'analyse approprié</li>
              <li>Cliquez sur "Lancer l'analyse"</li>
              <li>Consultez les résultats et visualisez les prédictions</li>
            </ol>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100"
             style="background-color: var(--bs-body-bg); color: var(--bs-body-color);">
          <div class="card-body">
            <h5 class="fw-bold mb-3" style="color: #6a007d;">Caractéristiques extraites</h5>
            <ul class="text-muted mb-0">
              <li>Durée et volume des flux</li>
              <li>Comptage de paquets et débits de transfert</li>
              <li>Distribution des tailles de paquets</li>
              <li>Temps inter-arrivées</li>
              <li>Protocole et ports utilisés</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

  </div>

  {% include 'includes/footer.html' %}
</main>
{% endblock content %}
{% include 'includes/scripts.html' %}

{% block javascripts %}
<!-- Script de gestion du mode sombre - Optimisé pour performance -->
<script>
(function() {
  'use strict';
  
  // Fonction pour appliquer le thème (sans reflow forcé)
  function applyTheme(isDark) {
    if (isDark) {
      document.body.classList.add('dark-version');
    } else {
      document.body.classList.remove('dark-version');
    }
  }

  // Appliquer le thème au chargement
  function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    applyTheme(savedTheme === 'dark');
  }

  // Écouter les changements du toggle directement (plus rapide que MutationObserver)
  function setupThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
      // Utiliser capture pour intercepter avant le script de navigation
      themeToggle.addEventListener('click', function() {
        // Petit délai pour laisser le script de navigation mettre à jour localStorage
        setTimeout(function() {
          const currentTheme = localStorage.getItem('theme');
          applyTheme(currentTheme === 'dark');
        }, 10);
      }, true);
    }
  }

  // Écouter les changements dans localStorage (synchronisation entre onglets uniquement)
  function setupStorageListener() {
    window.addEventListener('storage', function(e) {
      if (e.key === 'theme') {
        applyTheme(e.newValue === 'dark');
      }
    });
  }

  // Initialisation optimisée
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      initTheme();
      setupThemeToggle();
      setupStorageListener();

      // Bouton Réinitialiser: purge côté serveur + reset du formulaire
      const resetBtn = document.getElementById('resetBtn');
      const uploadForm = document.getElementById('uploadForm');
      if (resetBtn && uploadForm) {
        resetBtn.addEventListener('click', async function() {
          try {
            resetBtn.disabled = true;
            resetBtn.textContent = 'Nettoyage...';
            const res = await fetch('/clear-data', { method: 'GET', credentials: 'same-origin' });
            // Ignorer le contenu exact; l'objectif est de repartir propre
            uploadForm.reset();
            // Optionnel: petite notification minimaliste
            alert('Données temporaires effacées.');
          } catch (e) {
            alert("Impossible d'effacer les données temporaires.");
          } finally {
            resetBtn.disabled = false;
            resetBtn.textContent = 'Réinitialiser';
          }
        });
      }
    });
  } else {
    // DOM déjà chargé
    initTheme();
    setupThemeToggle();
    setupStorageListener();

    // Bouton Réinitialiser si DOM déjà prêt
    const resetBtn = document.getElementById('resetBtn');
    const uploadForm = document.getElementById('uploadForm');
    if (resetBtn && uploadForm) {
      resetBtn.addEventListener('click', async function() {
        try {
          resetBtn.disabled = true;
          resetBtn.textContent = 'Nettoyage...';
          const res = await fetch('/clear-data', { method: 'GET', credentials: 'same-origin' });
          uploadForm.reset();
          alert('Données temporaires effacées.');
        } catch (e) {
          alert("Impossible d'effacer les données temporaires.");
        } finally {
          resetBtn.disabled = false;
          resetBtn.textContent = 'Réinitialiser';
        }
      });
    }
  }
})();
</script>
{% endblock javascripts %}


